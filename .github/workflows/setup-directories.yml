name: Dependency and Directory Setup

on:
  pull_request:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  setup-and-verify:
    name: Setup Essential Directories and Dependencies
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Conditional directory creation for POSIX systems (Linux/macOS)
      # This step creates essential directories using mkdir -p which:
      # - Creates parent directories as needed (-p flag)
      # - Does not error if directories already exist
      # - Works on both Linux and macOS (POSIX-compliant systems)
      - name: Ensure essential directories (POSIX)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          echo "Creating essential directories on POSIX system..."
          mkdir -p scripts
          mkdir -p tools
          mkdir -p src
          mkdir -p transforms
          mkdir -p tests
          echo "Directory structure verified on ${{ runner.os }}"
          ls -la scripts/ tools/ src/ transforms/ tests/ 2>/dev/null || true

      # Conditional directory creation for Windows (PowerShell)
      # This step creates essential directories using New-Item which:
      # - Creates directories with -ItemType Directory
      # - Creates parent paths with -Force flag
      # - Suppresses errors if directories exist with -ErrorAction SilentlyContinue
      # - Is the native PowerShell way to handle directory creation
      - name: Ensure essential directories (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Creating essential directories on Windows..."
          New-Item -ItemType Directory -Force -Path scripts -ErrorAction SilentlyContinue | Out-Null
          New-Item -ItemType Directory -Force -Path tools -ErrorAction SilentlyContinue | Out-Null
          New-Item -ItemType Directory -Force -Path src -ErrorAction SilentlyContinue | Out-Null
          New-Item -ItemType Directory -Force -Path transforms -ErrorAction SilentlyContinue | Out-Null
          New-Item -ItemType Directory -Force -Path tests -ErrorAction SilentlyContinue | Out-Null
          Write-Host "Directory structure verified on ${{ runner.os }}"
          Get-ChildItem scripts,tools,src,transforms,tests -ErrorAction SilentlyContinue | Format-Table

      # Install dependencies before running import fixer
      # This ensures that the script itself can run if it has dependencies
      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.lock ]; then
            pip install -r requirements.lock
          fi
          if [ -f pyproject.toml ]; then
            pip install -e . --no-deps || echo "Package installation skipped"
          fi

      # Run the import fixer script to handle dependency improvements
      # This script:
      # - Scans Python files in tools/, src/, and transforms/
      # - Identifies missing imports based on code patterns
      # - Adds necessary import statements
      # - Ensures proper dependency declarations
      # Note: Generated during workflow execution to ensure latest version
      - name: Generate and run import fixer
        shell: bash
        run: |
          echo "Verifying insert_fix_tools_imports.py exists..."
          if [ -f scripts/insert_fix_tools_imports.py ]; then
            echo "Running import dependency improvements..."
            python scripts/insert_fix_tools_imports.py --dry-run
            echo "Import check completed successfully"
          else
            echo "Warning: scripts/insert_fix_tools_imports.py not found, skipping import fixes"
            exit 0
          fi

      # Verify the setup completed successfully
      # This step confirms that:
      # - All essential directories exist
      # - The import fixer script is present
      # - Python environment is properly configured
      - name: Verify setup
        shell: bash
        run: |
          echo "Verification Summary for ${{ runner.os }}:"
          echo "================================"
          
          # Check directories
          for dir in scripts tools src transforms tests; do
            if [ -d "$dir" ]; then
              echo "✓ Directory $dir exists"
            else
              echo "✗ Directory $dir missing"
              exit 1
            fi
          done
          
          # Check import fixer script
          if [ -f scripts/insert_fix_tools_imports.py ]; then
            echo "✓ Import fixer script exists"
            echo "  File size: $(wc -c < scripts/insert_fix_tools_imports.py) bytes"
          else
            echo "✗ Import fixer script missing"
            exit 1
          fi
          
          # Check Python version
          echo "✓ Python version: $(python --version)"
          
          echo "================================"
          echo "All verifications passed on ${{ runner.os }}"

      # Summary step to display workflow completion
      # Auto-expands to show the conditional inclusion logic used above:
      # - POSIX systems (Linux/macOS) use: mkdir -p
      # - Windows systems use: New-Item with -Force and -ErrorAction SilentlyContinue
      # - Both approaches ensure idempotent directory creation
      # - The import fixer runs after directories are confirmed
      - name: Summary
        shell: bash
        run: |
          echo "Workflow Completed Successfully!"
          echo "================================"
          echo "Platform: ${{ runner.os }}"
          echo "Python: $(python --version)"
          echo ""
          echo "Directory creation method used:"
          if [ "${{ runner.os }}" == "Windows" ]; then
            echo "  - PowerShell: New-Item -ItemType Directory -Force"
          else
            echo "  - POSIX: mkdir -p"
          fi
          echo ""
          echo "Import fixer script: scripts/insert_fix_tools_imports.py"
          echo "Status: Ready for build process"
          echo "================================"
